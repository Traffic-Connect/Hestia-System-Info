#!/bin/bash
#
# ĞšĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Hestia: v-system-info
# Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ CPU, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸ÑĞºĞ°, RAM, ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ±ĞµĞºĞ°Ğ¿Ğ° Ğ¸ Ğ¿Ğ°Ğ¿ĞºĞ¸ Ğ² /root
#
# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: ./v-system-info [--json|--text]
#

# Ğ¦Ğ²ĞµÑ‚Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # Ğ‘ĞµĞ· Ñ†Ğ²ĞµÑ‚Ğ°

# Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ‰ÑƒÑ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºÑƒ ĞµÑĞ»Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°
LIB_DIR="$(cd "$(dirname "$0")" && pwd)/lib"
[ -f "$LIB_DIR/system_info.sh" ] || LIB_DIR="/usr/local/hestia/lib/hestia-system-info"
[ -f "$LIB_DIR/system_info.sh" ] && . "$LIB_DIR/system_info.sh"

# Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
OUTPUT_FORMAT="text"

# ĞŸĞ°Ñ€ÑĞ¸Ğ¼ Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸
while [[ $# -gt 0 ]]; do
    case $1 in
        --json)
            OUTPUT_FORMAT="json"
            shift
            ;;
        --text)
            OUTPUT_FORMAT="text"
            shift
            ;;
        -h|--help)
            echo "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: $0 [--json|--text]"
            echo "  --json    Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ JSON"
            echo "  --text    Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ² Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼Ğ¾Ğ¼ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ)"
            echo "  -h, --help ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ñƒ ÑĞ¿Ñ€Ğ°Ğ²ĞºÑƒ"
            exit 0
            ;;
        *)
            echo "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ Ğ¾Ğ¿Ñ†Ğ¸Ñ: $1"
            echo "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ -h Ğ¸Ğ»Ğ¸ --help Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞ¿Ñ€Ğ°Ğ²ĞºĞ¸"
            exit 1
            ;;
    esac
done

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ CPU (Ğ·Ğ°Ğ¿Ğ°ÑĞ½Ğ¾Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ ĞµÑĞ»Ğ¸ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ° Ğ½Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ°)
if ! declare -F get_cpu_model >/dev/null; then
get_cpu_model() {
    if [ -f /proc/cpuinfo ]; then
        grep "model name" /proc/cpuinfo | head -1 | cut -d: -f2 | xargs
    else
        lscpu | grep "Model name" | cut -d: -f2 | xargs 2>/dev/null || echo ""
    fi
}
fi

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ğ² Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ
output_text() {
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘                    ğŸ–¥ï¸  Ğ˜ĞĞ¤ĞĞ ĞœĞĞ¦Ğ˜Ğ¯ Ğ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ•                    â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    
    # ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ñ€Ğ°
    echo -e "${YELLOW}ğŸ”§ ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ñ€Ğ°:${NC}"
    local cpu_model=$(get_cpu_model)
    echo -e "   ${GREEN}â–º${NC} $cpu_model"
    echo
    
    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸ÑĞºĞ°
    echo -e "${YELLOW}ğŸ’¾ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸ÑĞºĞ°:${NC}"
    local disk_usage=$(get_disk_usage)
    local disk_info=$(get_disk_info)
    local total=$(echo "$disk_info" | jq -r '.total' 2>/dev/null || echo "Ğ/Ğ”")
    local used=$(echo "$disk_info" | jq -r '.used' 2>/dev/null || echo "Ğ/Ğ”")
    local available=$(echo "$disk_info" | jq -r '.available' 2>/dev/null || echo "Ğ/Ğ”")
    
    # ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ-Ğ±Ğ°Ñ€ Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¸ÑĞºĞ°
    local bar_length=20
    local filled=$(awk "BEGIN {printf \"%.0f\", $disk_usage * $bar_length / 100}" 2>/dev/null || echo "0")
    local empty=$((bar_length - filled))
    
    local progress_bar=""
    for ((i=0; i<filled; i++)); do
        progress_bar="${progress_bar}â–ˆ"
    done
    for ((i=0; i<empty; i++)); do
        progress_bar="${progress_bar}â–‘"
    done
    
    # Ğ¦Ğ²ĞµÑ‚ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    local usage_color=$GREEN
    if [ "$(awk "BEGIN {print ($disk_usage > 80) ? 1 : 0}")" -eq 1 ]; then
        usage_color=$RED
    elif [ "$(awk "BEGIN {print ($disk_usage > 60) ? 1 : 0}")" -eq 1 ]; then
        usage_color=$YELLOW
    fi
    
    echo -e "   ${GREEN}â–º${NC} Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: ${usage_color}${disk_usage}%${NC} [${progress_bar}]"
    echo -e "   ${GREEN}â–º${NC} Ğ’ÑĞµĞ³Ğ¾: ${BLUE}$total${NC}"
    echo -e "   ${GREEN}â–º${NC} Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¾: ${YELLOW}$used${NC}"
    echo -e "   ${GREEN}â–º${NC} Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾: ${GREEN}$available${NC}"
    echo
    
    # Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ RAM
    echo -e "${YELLOW}ğŸ§  Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ RAM:${NC}"
    local ram_info=$(get_ram_info)
    local ram_total=$(echo "$ram_info" | jq -r '.total' 2>/dev/null || echo "Ğ/Ğ”")
    local ram_used=$(echo "$ram_info" | jq -r '.used' 2>/dev/null || echo "Ğ/Ğ”")
    local ram_free=$(echo "$ram_info" | jq -r '.free' 2>/dev/null || echo "Ğ/Ğ”")
    local ram_usage_percent=$(echo "$ram_info" | jq -r '.usage_percent' 2>/dev/null || echo "Ğ/Ğ”")
    
    # ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ-Ğ±Ğ°Ñ€ Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ RAM
    local ram_bar_length=20
    local ram_filled=$(awk "BEGIN {printf \"%.0f\", $ram_usage_percent * $ram_bar_length / 100}" 2>/dev/null || echo "0")
    local ram_empty=$((ram_bar_length - ram_filled))
    
    local ram_progress_bar=""
    for ((i=0; i<ram_filled; i++)); do
        ram_progress_bar="${ram_progress_bar}â–ˆ"
    done
    for ((i=0; i<ram_empty; i++)); do
        ram_progress_bar="${ram_progress_bar}â–‘"
    done
    
    # Ğ¦Ğ²ĞµÑ‚ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ RAM
    local ram_usage_color=$GREEN
    if [ "$(awk "BEGIN {print ($ram_usage_percent > 80) ? 1 : 0}")" -eq 1 ]; then
        ram_usage_color=$RED
    elif [ "$(awk "BEGIN {print ($ram_usage_percent > 60) ? 1 : 0}")" -eq 1 ]; then
        ram_usage_color=$YELLOW
    fi
    
    echo -e "   ${GREEN}â–º${NC} Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: ${ram_usage_color}${ram_usage_percent}%${NC} [${ram_progress_bar}]"
    echo -e "   ${GREEN}â–º${NC} Ğ’ÑĞµĞ³Ğ¾: ${BLUE}$ram_total${NC}"
    echo -e "   ${GREEN}â–º${NC} Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¾: ${YELLOW}$ram_used${NC}"
    echo -e "   ${GREEN}â–º${NC} Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾: ${GREEN}$ram_free${NC}"
    echo
    
    # Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ±ĞµĞºĞ°Ğ¿Ğ°
    echo -e "${YELLOW}ğŸ’¾ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ±ĞµĞºĞ°Ğ¿Ğ°:${NC}"
    local backup_info=$(check_backup_status)
    local backup_enabled=$(echo "$backup_info" | jq -r '.enabled' 2>/dev/null || echo "false")
    local backup_status=$(echo "$backup_info" | jq -r '.status' 2>/dev/null || echo "Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾")
    
    if [ "$backup_enabled" = true ]; then
        echo -e "   ${GREEN}â–º${NC} Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: ${GREEN}âœ… $backup_status${NC}"
    else
        echo -e "   ${GREEN}â–º${NC} Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: ${RED}âŒ $backup_status${NC}"
    fi
    echo
    
    # ĞŸĞ°Ğ¿ĞºĞ¸ Ğ² /root
    echo -e "${YELLOW}ğŸ“ ĞŸĞ°Ğ¿ĞºĞ¸ Ğ² /root:${NC}"
    local folders_info=$(check_root_folders)
    
    echo "$folders_info" | jq -r 'to_entries[] | "   â–º \(.key): \(if .value.exists then "âœ… Ğ¡Ğ£Ğ©Ğ•Ğ¡Ğ¢Ğ’Ğ£Ğ•Ğ¢" else "âŒ ĞĞ• ĞĞĞ™Ğ”Ğ•ĞĞ" end)"' 2>/dev/null || {
        # Ğ—Ğ°Ğ¿Ğ°ÑĞ½Ğ¾Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ ĞµÑĞ»Ğ¸ jq Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½
        for folder in "link-manager" "google-auth" "tc-api-site-details"; do
            if [ -d "/root/$folder" ]; then
                echo -e "   ${GREEN}â–º${NC} $folder: ${GREEN}âœ… Ğ¡Ğ£Ğ©Ğ•Ğ¡Ğ¢Ğ’Ğ£Ğ•Ğ¢${NC}"
            else
                echo -e "   ${GREEN}â–º${NC} $folder: ${RED}âŒ ĞĞ• ĞĞĞ™Ğ”Ğ•ĞĞ${NC}"
            fi
        done
    }
    echo
    
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘                      ğŸ“Š ĞšĞĞĞ•Ğ¦ ĞĞ¢Ğ§Ğ•Ğ¢Ğ                          â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ JSON
output_json() {
    local cpu_model=$(get_cpu_model)
    local disk_info=$(get_disk_info)
    local ram_info=$(get_ram_info)
    local backup_info=$(check_backup_status)
    local folders_info=$(check_root_folders)
    
    cat << EOF
{
  "cpu": {
    "model": "$cpu_model"
  },
  "disk": $disk_info,
  "ram": $ram_info,
  "remote_backup": $backup_info,
  "root_folders": $folders_info,
  "timestamp": "$(date '+%Y-%m-%d %H:%M:%S')",
  "server_timezone": "$(date '+%Z')"
}
EOF
}

# ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ
if [ "$OUTPUT_FORMAT" = "json" ]; then
    output_json
else
    output_text
fi
